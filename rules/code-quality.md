# 代码质量规范

代码变更交付前必须通过以下门禁：
- 必查 4 项：正确性、安全、性能、可维护性
- 验证按适用性执行（见第 5 节）

纯文档/问答任务可跳过编译与测试。

## 1) 正确性

- 需求行为完整，边界条件可解释
- 错误处理清晰，不吞异常
- 不引入明显回归（接口、时序、输出格式）
- 共享可变状态有明确同步机制
- 资源（连接、句柄、流）及时释放

## 2) 安全

- 外部输入先校验（类型/长度/格式/范围）
- 禁止 SQL/命令拼接，使用参数化或安全 API
- 禁止硬编码密钥、token、凭证
- 受保护资源必须做鉴权与归属检查

## 3) 性能

- 热路径避免 O(n²) 及以上复杂度
- 禁止循环内重复 I/O、分配或查询
- 禁止不必要的大对象拷贝或序列化

## 4) 可维护性

- 单一职责：函数/模块职责清晰
- 命名可读：变量用名词，函数用动词
- 复杂逻辑补充“为什么”的注释
- DRY：2+ 处相同/高度相似代码必须消除重复（提取函数/模块/共享组件）
- YAGNI：禁止推测性功能、未请求抽象、不可能场景的错误处理
- 复杂度检验：若资深工程师会说“改得太多/太复杂”，则继续简化

## 5) 验证

按优先级执行全部适用验证（禁止只挑最少项）：

1. Typecheck / Build：不过则后续验证无意义
2. Lint：风格与潜在错误检查
3. 测试：能跑必须跑；不能跑要说明原因、残余风险与替代方式
4. 手动验证：无法自动化时补充

- 报告必须包含验证证据（完整命令 + 输出摘要 + 受限项）
- 禁止未执行验证却声称“已验证”

## 红旗

### 立即阻断（出现即停止当前工作并修复）

- 安全：SQL/命令拼接、动态执行不受控代码（eval）、未校验输入直接入库/执行
- 安全：敏感信息写入日志或硬编码到代码
- 正确性：关键错误被忽略或静默失败

### 优先修复（在通用退出标准第 4 步质量门禁中处理）

- 跨文件重复代码块
- 单次使用场景的过度抽象
