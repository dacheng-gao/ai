# 代码质量规范

## 概述

本规范定义了跨语言的代码质量标准，适用于所有 AI 生成的代码。目标：确保代码安全、可维护、符合最佳实践。

**核心原则：** 代码必须通过静态检查才视为完成。

---

## SOLID 原则

### S - 单一职责原则 (Single Responsibility)
- 一个类/模块只有一个变更理由
- 函数只做一件事，控制在 20-30 行以内
- 避免"上帝类" (God Class) 和"上帝函数"

### O - 开闭原则 (Open/Closed)
- 对扩展开放，对修改关闭
- 使用策略模式、模板方法模式实现可扩展性
- 新功能通过插件/继承添加，而非修改已有代码

### L - 里氏替换原则 (Liskov Substitution)
- 子类可以无缝替换父类
- 不削弱父类的约束，不增强父类的假设
- 返回值协变、参数逆变

### I - 接口隔离原则 (Interface Segregation)
- 接口小而专注，避免胖接口 (Fat Interface)
- 客户端不应依赖它不使用的方法
- 按角色拆分接口（如 `Readable`、`Writable` 分离）

### D - 依赖倒置原则 (Dependency Inversion)
- 高层模块不依赖低层模块，都依赖抽象
- 依赖注入 (DI) 优于硬编码依赖
- 抽象不依赖细节，细节依赖抽象

---

## 安全准则 (基于 OWASP Top 10:2025)

### 输入验证
- [ ] 所有外部输入必须验证（白名单优先于黑名单）
- [ ] 类型、长度、格式、范围检查
- [ ] 拒绝无效输入，勿尝试清洗

### 注入防护
- [ ] SQL：使用参数化查询 / ORM
- [ ] 命令：避免 shell 拼接，使用 API 调用
- [ ] XSS：输出编码，CSP 策略
- [ ] 路径遍历：验证路径白名单，不拼接用户输入

### 认证与授权
- [ ] 敏感操作需二次验证
- [ ] 最小权限原则
- [ ] 会话超时与安全登出
- [ ] 资源归属检查（访问资源 = 检查所有权）

### 敏感数据
- [ ] 密码加密存储（bcrypt/argon2，最小 12 轮）
- [ ] 日志脱敏（不记录密码、token、PII）
- [ ] 传输层加密 (HTTPS/TLS)
- [ ] 密钥不硬编码，使用环境变量或密钥管理服务

---

## Clean Code 原则

### 命名
| 类型 | 规范 |
|------|------|
| 变量 | 名词，小驼峰 (camelCase)，描述内容而非类型 |
| 函数 | 动词短语，小驼峰 |
| 类/接口 | 名词，大驼峰 (PascalCase) |
| 常量 | UPPER_SNAKE_CASE |
| 布尔 | `is/has/should/can` 前缀 |

**反模式：** `data1`, `temp`, `flag`, `doIt()`
**正确：** `userProfile`, `isValidUser`, `calculateTotal()`

### 函数设计
- 单一职责，3-4 个参数以内
- 参数过多 → 封装为参数对象
- 避免标志参数 (flag argument)，拆分函数
- 返回值明确，优先返回 Result/Tuple 而非异常

### 注释
- **为什么** 比 **是什么** 重要
- 复杂业务逻辑必须注释
- 算法意图必须注释
- 代码自解释优先，注释补充意图

---

## 代码复杂度指标

### 圈复杂度 (Cyclomatic Complexity)
```
CC = E - N + 2P
E = 边数, N = 节点数, P = 连通分量
```

| 分数 | 评级 | 行动 |
|------|------|------|
| 1-10 | 低 | 无需重构 |
| 11-20 | 中 | 考虑重构 |
| 21+ | 高 | 必须重构 |

### 可维护性指数 (Maintainability Index)
```
MI = MAX(0, (171 - 5.2 * ln(HV) - 0.23 * CC - 16.2 * ln(LOC)) * 100 / 171)
HV = Halstead Volume
```

| 分数 | 评级 |
|------|------|
| 85-100 | 高 |
| 65-85 | 中 |
| 0-64 | 低 |

**目标：** MI ≥ 65，CC ≤ 10

---

## 语言特定实践

### Java
- 优先使用 `interface` 和 `abstract class` 定义抽象
- 使用 `Optional` 替代 null 返回
- 异常处理：特定异常优先，避免捕获 `Throwable`
- 资源管理：try-with-resources
- 并发：`java.util.concurrent` 优于手动同步

### .NET (C#)
- 使用 `async/await` 处理异步，避免 `.Result` 死锁
- `record` 类型用于不可变数据
- `Pattern Matching` 替代 `is` + cast
- `dependency injection` 容器管理生命周期
- `IDisposable` 正确实现（释放模式）

### Go
- 错误处理：永远检查 error，勿忽略
- Interface：小而专注，接受方定义
- goroutine 泄漏检查：context 用于取消
- 通道 buffered 与 unbuffered 选择明确

### Python
- Type Hints 必须用于公共 API
- `with` 语句管理资源
- 列表推导式简单优先，复杂用循环
- 避免 `*args`/`**kwargs` 滥用，参数明确

### TypeScript/JavaScript
- Type strict mode，禁用 `any`
- 优先 `const`，其次 `let`，禁用 `var`
- 异步：`async/await` 优于 Promise 链
- 空值合并：`??` 和可选链 `?.`

---

## AI 代码生成验证清单

### 生成时必须检查
- [ ] 无硬编码密钥/凭证
- [ ] 无 SQL/命令注入风险
- [ ] 错误处理完整（不吞异常）
- [ ] 资源正确关闭（文件、连接、句柄）
- [ ] 并发安全（共享状态保护）
- [ ] 边界条件处理（null、空、零、负数）
- [ ] 循环无无限风险

### 生成后验证

**编译验证（强制）**
- [ ] 代码必须能成功编译，无编译错误
- [ ] 导入/依赖路径正确，无缺失引用
- [ ] 类型检查通过（TS/C#/Java/Kotlin 等）

**运行验证**
- [ ] 测试覆盖主路径和边界
- [ ] 无 linter 警告
- [ ] 符合项目风格指南

---

## 完成标准

代码交付前必须满足：

1. **编译通过** — 无编译错误，依赖正确
2. **类型检查** — 静态类型检查通过（如适用）
3. **静态检查** — 无 linter 警告，符合代码风格
4. **安全检查** — 通过红旗模式筛查
5. **测试覆盖** — 主路径和边界条件有测试

**核心原则：** 代码必须能编译、能运行、能通过静态检查，才视为完成。

---

## 规则优先级

1. **编译通过** > 安全 > 可用性 > 性能 > 可读性
2. 本规范 > 项目本地规范（冲突时覆盖）
3. 明确禁止项 > 推荐实践

---

## 红旗 - 立即停止

以下模式必须拒绝：

| 模式 | 风险 |
|------|------|
| 拼接 SQL 字符串 | SQL 注入 |
| `eval()` / 动态执行 | 代码注入 |
| 硬编码密钥 | 密钥泄露 |
| 忽略返回错误 | 静默失败 |
| 未验证用户输入 | 注入/越权 |
| 未关闭资源 | 泄漏 |
| 全局可变状态 | 并发 bug |

---

## 快速参考

| 类别 | 关键词 |
|------|--------|
| SOLID | SRP, OCP, LSP, ISP, DIP |
| 安全 | 输入验证, 参数化查询, 最小权限, 加密存储 |
| 复杂度 | CC ≤ 10, MI ≥ 65 |
| 命名 | 动词函数, 名词变量, is/has 布尔 |
| 资源 | try-with-resources, with, using, IDisposable |
| 并发 | 竞态条件检查, 超时, 取消 |
