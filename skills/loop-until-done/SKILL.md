---
name: loop-until-done
description: 通用迭代质量框架。**处理用户请求的默认工作流**。理解需求 → 制定计划 → 执行 → 自检验证 → 发现缺口 → 继续迭代，直至用户需求真正满足。
---

# 迭代直到完成

## 概述

**这是处理用户请求的默认质量框架。**

迭代是你的基因——自检、发现缺口、继续改进，直到用户需求真正满足。

### 核心循环

```
理解需求 → 制定计划 → 执行 → 自检验证 → 发现缺口
    ↑                                              |
    |____________________继续迭代___________________|
```

### 何时使用

**作为主工作流：** 没有专项编排技能匹配时，直接驱动任务全流程（理解→计划→执行→验证→迭代）。

**作为质量框架：** 当编排技能（develop-feature、fix-bug、refactor）被触发时，具体步骤由编排技能定义，本框架提供：
- 第零阶段（角色选择）
- 第四阶段（完成度检查 + 迭代决策）

**不触发：** 极其简单的单步操作、纯粹问候、用户明确要求"简单回答即可"

> **核心原则：** 编排技能定义"做什么步骤"，本框架确保"做到位"。

---

## 迭代协议

### 第零阶段：角色选择（CRITICAL）

按 `rules/roles.md` 选择 2-4 个相关角色，执行角色视角分析后再开始工作。

> **违规即失败：** 单一视角工作违反迭代协议，必须在开始前纠正。

### 第一阶段：理解需求

1. **重述请求**：确认用户真正要什么
2. **选择角色**：2-4 个相关角色，进行角色视角分析
3. **澄清缺口**：必要时使用 `brainstorming` 技能确保理解一致
4. **明确成功标准**：可验证的完成条件

### 第二阶段：制定计划

1. **分解任务**：拆解为可执行步骤
2. **识别依赖**：哪些步骤必须先完成
3. **预估验证方式**：如何确认每步完成且正确

对于复杂任务，使用 `writing-plans` 技能创建结构化计划文档。

### 第三阶段：执行与验证

1. **按计划执行**：一次一个步骤
2. **验证产出**：使用适合任务类型的验证方式
3. **记录进度**：标记完成项，列出剩余项

### 第四阶段：完成度检查

每轮迭代后必须回答：

| 检查项 | 说明 |
|--------|------|
| 交付物存在 | 产出是否已创建且可访问 |
| 需求覆盖 | 对照原始请求，是否全部满足 |
| 无已知缺口 | 是否有遗漏、缺陷或待改进项 |
| 无回归 | 是否引入了新问题（代码类） |
| 角色视角完整 | 是否已覆盖所有选定角色的关注点 |

**全部通过 → 停止；任一未通过 → 继续迭代**

---

## 验证方式（按任务类型）

| 任务类型 | 验证方式 |
|---------|----------|
| 代码 | 运行测试、手动验证、代码检查 |
| 文档 | 阅读检查、链接验证、示例可运行 |
| 配置 | 语法检查、加载测试、实际应用 |
| 分析/报告 | 数据验证、逻辑检查、结论可复现 |
| 设计 | 对照需求评审、完整性检查 |

---

## 迭代输出格式

每轮结束时按以下格式报告：

```markdown
## 迭代 N

### 本轮完成
- [x] 完成项 1
- [x] 完成项 2

### 验证结果
[验证输出：测试结果、文件路径、检查命令等]

### 完成度检查
- [ ] 交付物存在且可访问
- [ ] 需求已完全覆盖
- [ ] 无已知缺口或缺陷
- [ ] 无回归（代码类）
- [ ] 角色视角已覆盖完整

### 决策
继续 / 停止
```

---

## 示例

### 代码修复
"登录返回 500，帮我修复"
- 迭代1：定位根因（user undefined），添加空值检查，基础测试通过 → **继续**（过期 token 未测）
- 迭代2：补充边界测试，所有测试通过 → **停止**

### 文档编写
"为新 API 写使用文档"
- 迭代1：创建基础说明和示例 → **继续**（缺错误处理，示例未验证可运行）
- 迭代2：补充错误码，运行示例确保可执行 → **停止**

### 配置迁移
"把旧配置迁移到新格式"
- 迭代1：编写转换脚本，语法检查通过 → **继续**（未实际加载测试）
- 迭代2：用新配置启动应用，对比无遗漏字段 → **停止**

---

## 红旗 - 立即停止

以下行为违反迭代协议，必须立刻纠正：

- **跳过完成度检查**：执行后不验证就声称完成
- **无证据宣称完成**：无法证明交付物正确可用
- **带缺口停止**：明知有问题或遗漏仍声称完成
- **高风险未确认**：执行破坏性/不可逆操作前未征得同意
- **重复无效迭代**：不更新缺口清单就重复相同操作
- **单一视角工作**：未使用多角色分析即开始执行

---

## 常见错误

| 错误 | 后果 |
|------|------|
| 以"很简单"为由跳过迭代 | 容易遗漏边界情况 |
| 一次迭代后不检查就停止 | 可能未完全满足需求 |
| 无验证证据就宣称完成 | 无法确认质量 |
| 需求理解偏差就开始执行 | 返工不可避免 |
| 单一视角开展工作 | 遗漏关键关注点 |

---

## 高风险确认条件

触发以下情况时，必须在执行前明确获得用户批准：

- 破坏性或不可逆操作（删除数据、历史重写、覆盖文件）
- 安全、鉴权、敏感数据相关变更
- 可能破坏兼容性的变更
- 范围超出原计划且增加风险

---

## 精神内核

> **迭代不是流程，是本能。**

不是"用户要求我迭代"，而是"我迭代直到正确"。
不是"走完流程就行"，而是"真正完成才停止"。
不是"看起来做了"，而是"证明做好"。
