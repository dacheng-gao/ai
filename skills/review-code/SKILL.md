---
name: review-code
description: 当需要评审代码、PR、diff 或补丁的正确性、安全性、性能或可维护性风险时使用。
---

# 代码评审

## 概述

**这是一个编排技能** - 组织 superpowers 代码评审流程。

本项目依赖 [superpowers plugin](https://github.com/obra/superpowers) 提供的基础评审流程。

## 必需子技能 (REQUIRED SUB-SKILLS)

根据场景选择：

**评审他人代码时：**
1. 使用本技能的 checklist
2. 评审完成后调用 `superpowers:requesting-code-review`

**接收评审反馈时：**
1. 调用 `superpowers:receiving-code-review`
2. 理解反馈，验证技术合理性
3. 逐步实施修复

## 何时使用

- 代码/PR/diff/补丁评审
- 关注 bug、安全、性能或可维护性风险
- 合并/审批前评审

**不适用：**
- 未提供代码或 diff（先请求提供）
- 仅架构/设计讨论（用 architecture-review）

## 评审检查清单

### 正确性
- [ ] 代码是否实现了预期功能
- [ ] 边界条件是否处理
- [ ] 错误处理是否完整

### 安全性
- [ ] 输入验证是否充分
- [ ] 是否有注入风险
- [ ] 敏感数据是否保护

### 性能
- [ ] 是否有不必要的复杂度
- [ ] 是否有潜在的性能瓶颈
- [ ] 资源使用是否合理

### 可维护性
- [ ] 代码是否清晰易懂
- [ ] 命名是否准确
- [ ] 是否有适当注释
- [ ] 是否符合项目风格

## 快速参考

| 场景 | 使用 |
|---|---|
| 评审 PR | 本技能 checklist + requesting-code-review |
| 接收反馈 | receiving-code-review → systematic-dbg → tdd |

## 评审方法

### 先扫后看
- 快速扫描 diff 的全局，再深入细节
- 优先报告 Critical 和 Important 问题

### 按严重度排序
1. **Critical**：安全、越权、数据丢失、崩溃
2. **Important**：逻辑 bug、性能回退、不稳定行为
3. **Suggestion**：可读性、命名、小型重构

### 问题报告格式
每个问题应该包含：
- **位置**：文件:行 或代码片段
- **严重度**：Critical / Important / Suggestion
- **问题**：清晰描述问题
- **影响**：可能造成的后果
- **修复**：具体可执行的修复建议

## 输出格式

- 先列问题，按严重度排序
- 每个问题包含：位置、严重度、影响、修复
- 然后写开放问题/假设
- 最后 1-2 句总结
- 若无问题，明确说明 + 残余风险/测试缺口

## 示例

```markdown
### 问题
- b/api/users.ts:42
  严重度: Critical
  问题: 缺少鉴权/归属检查，任意用户可更新资料
  修复: 要求 `requireUser()` 并校验 `user.id` 与目标一致

- b/db/users.ts:88
  严重度: Important
  问题: 无界查询在负载下会引发 N+1 行为
  修复: 增加 LIMIT 并批量获取关联数据

### 问题/假设
- 该 handler 之前是否总有中间件设置 `req.user`？

### 总结
- 鉴权检查加入前阻止合并；性能问题可后续处理
```

## 与 superpowers 的集成

### requesting-code-review
在完成评审后调用，确保：
- 评审有明确的目标
- 问题有可执行的修复建议
- 必要时进行跟进评审

### receiving-code-review
当收到评审反馈时调用：
- 理解反馈的意图
- 验证技术合理性（不盲从）
- 使用 systematic-debugging 调查复杂问题
- 使用 TDD 实施修复

## 常见错误

- 只挑风格，忽略安全和正确性
- 不标位置或严重度
- 修复建议含糊（"优化一下"）
- 盲目接受反馈而不验证

## 借口 vs 事实

| 借口 | 事实 |
| --- | --- |
| "没时间标行号" | 没位置就没法修复；至少给文件与片段。 |
| "用户只要快速评审" | 快速也要先看高严重度问题。 |
| "要友好，别说问题" | 隐藏关键问题会造成真实伤害。 |
| "没发现就说看起来不错" | 明确无问题并列出残余风险或测试缺口。 |

## 红旗 - 立即停止

- "随便扫一眼就批准"
- "只提风格意见"
- "不标文件/行"
- "只有总结，没有问题"
- "未说明是否有问题"

## 与原技能的区别

**原版本：** 自定义代码评审流程

**新版本：** 编排者模式，集成 superpowers 代码评审技能

好处：
- 评审请求和接收反馈有专门技能处理
- 与 superpowers 生态系统一致
