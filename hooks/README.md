# Hooks 配置说明

本目录包含 Claude Code 生命周期钩子脚本。

## 已配置的 Hooks

| Hook | 事件 | 用途 |
|------|------|------|
| `prompt-refiner.sh` | UserPromptSubmit | 检测提示词清晰度，触发意图审查 |
| `session-start.sh` | SessionStart(startup) | 检测 HANDOFF.md，提示恢复会话 |
| `pre-write-check.sh` | PreToolUse(Write\|Edit) | 阻止敏感文件修改，警告未提交变更 |
| `pre-compact.sh` | PreCompact | 上下文压缩前保存关键信息 |
| `post-compact.sh` | SessionStart(compact) | 压缩后注入框架提醒 |

## prompt-refiner 工作原理

**核心思路**：通过理解-复述-澄清的对话模式，确保双方对目标达成共识后再执行。

```
用户输入 → hook 检测清晰度
                ↓
    ┌───────────┼───────────┐
    ↓           ↓           ↓
  清晰        中等         模糊
  (≤20)      (21-45)      (46+)
    ↓           ↓           ↓
  无注入     注入工作区    触发意图澄清
  零开销     上下文辅助    理解→复述→对话
    ↓           ↓           ↓
  直接执行   直接执行     共识后生成方案
```

### 三级响应

| 清晰度 | 分数 | Hook 输出 | Claude 行为 |
|--------|------|-----------|-------------|
| 清晰 | 0-20 | 无（exit 0） | 直接进入技能路由 |
| 中等 | 21-45 | `<workspace-context>` | 参考上下文辅助推断，直接执行 |
| 模糊 | 46+ | `<refine-prompt>` | 扫描代码库 → 生成执行方案 → 用户确认 |

### 清晰度评分规则

| 规则 | 加分 | 说明 |
|------|------|------|
| 长度 < 10 字符 | +35 | 过短请求缺少上下文 |
| 长度 10-25 字符 | +15 | 可能缺少细节 |
| 缺少动作动词（中英文） | +25 | 无 fix/add/修复/添加 等明确动词 |
| 含模糊词汇（中英文） | +20 | something/搞一下/处理一下 等 |
| 无对象引用（中英文） | +15 | 无文件/模块/组件/接口 指定 |
| 纯提问短句 | +10 | 仅提问无行动请求 |

### 快速跳过（不评分）

以下情况直接放行，零开销：
- Slash 命令（`/commit`、`/help`）
- 单词确认（`y`、`ok`、`继续`）
- 含代码块（` ``` `）
- 超过 200 字符
- 含文件路径 + 动作动词

### 执行方案格式

当 Claude 收到 `<refine-prompt>` 信号后，生成如下方案供用户确认：

```markdown
## [type]: [标题]

### 目标
[最终状态描述]

### 范围
- [文件/模块] — [改动说明]

### 行为规格
- WHEN [条件] THEN [预期]

### 验收标准
- [ ] [可验证条件]

### 不做
- [排除项]
```

## 调试

启用 debug 模式查看 hook 执行详情：

```bash
claude --debug
```
